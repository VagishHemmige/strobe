---
title: "Plotting STROBE Diagrams"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Plotting STROBE Diagrams}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

The STROBE (Strengthening the Reporting of Observational Studies in Epidemiology) statement encourages the transparent reporting of observational studies. One important element is a flow diagram that documents how the study population was selected.

The `strobe` package provides tools to generate reproducible STROBE-style diagrams from your cohort-building process. This vignette shows how to use `plot_strobe_diagram()` to visualize cohort selection, and how to adjust visual parameters for publication-ready output.

This vignette assumes you’ve already built a STROBE derivation log using `strobe_initialize()` and `strobe_filter()`.

## Setup

```{r}
library(strobe)
library(dplyr)
library(medicaldata)

data(cytomegalovirus)

cytomegalovirus_final_df<-cytomegalovirus %>%
  strobe_initialize("All transplant recipients") %>%
  strobe_filter("age >= 18 & age <= 65", "Age 18–65", "Excluded: Outside 18–65") %>%
  strobe_filter("recipient.cmv == 1", "CMV positive", "Excluded: CMV negative") %>%
  strobe_filter("donor.cmv == 1", "Donor CMV positive", "Excluded: Donor CMV negative") %>%
  strobe_filter("prior.transplant == 0", "No prior transplant", "Excluded: Prior transplant")
```

## Basic Usage

The most basic STROBE diagram can be produced by simply calling:

```{r}
plot_strobe_diagram()
```

## Controlling Box Size

If your text is getting truncated or looks cramped, adjust the box dimensions.

### Wider and Taller Boxes

```{r}
plot_strobe_diagram(incl_width_min = 4, incl_height = 1.2)
```

### Locking Size Across Boxes

Locking height/width ensures all boxes are uniform:

```{r}
plot_strobe_diagram(lock_width_min = TRUE, lock_height = TRUE)
```

This is especially helpful when you have multi-line text in some nodes but not others.

## Adjusting Font Size

You can separately control font sizes for inclusion and exclusion boxes:

```{r}
plot_strobe_diagram(incl_fontsize = 16, excl_fontsize = 14)
```

Use larger fonts for presentation or slide decks:

```{r}
plot_strobe_diagram(incl_fontsize = 20, excl_fontsize = 18)
```

## Combining Size and Font Adjustments

Here’s an example with many settings tuned:

```{r}
plot_strobe_diagram(
  incl_width_min = 5,
  excl_width_min = 4,
  incl_height = 1.5,
  excl_height = 1.2,
  incl_fontsize = 18,
  excl_fontsize = 16,
  lock_width_min = TRUE,
  lock_height = TRUE
)
```

## Exporting Diagrams

You can export to PNG or SVG formats. This is helpful for manuscripts or presentations.

### Export as PNG

```{r}
plot_strobe_diagram(export_file = "strobe_diagram.png")
```

### Export as SVG

```{r}
plot_strobe_diagram(export_file = "strobe_diagram.svg")
```

Make sure to commit these files if your vignette is included in a GitHub-hosted site.

## Troubleshooting Layout

If boxes are overlapping or lines look incorrect:

### Try Locking Width/Height

```{r}
plot_strobe_diagram(lock_width_min = TRUE)
```

```{r}
plot_strobe_diagram(lock_height = TRUE)
```

### Use Fewer Words or Manual Line Breaks

Use `\n` in labels to manually split long lines. Example:

```{r eval=FALSE}
strobe_filter(
  condition = "...",
  inclusion_label = "Eligible recipients\nwith CMV+ donors",
  exclusion_reason = "Excluded:\nCMV- donors"
)
```

This often improves appearance more than tweaking sizes alone.

## Summary

`plot_strobe_diagram()` gives you fine-grained control over the appearance of STROBE cohort diagrams. You can:

- Tune box dimensions
- Control font sizes
- Lock box sizes for uniform appearance
- Export to PNG or SVG for publication use

These tools help make your derivation logic transparent, reproducible, and ready for review.
